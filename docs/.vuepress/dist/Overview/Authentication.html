<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.53">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Authentication | PACDoc</title><meta name="description" content="PACMan documentation">
    <link rel="preload" href="/assets/style.b1036708.css" as="style" /><link rel="stylesheet" href="/assets/style.b1036708.css" />
    <link rel="modulepreload" href="/assets/app.4217e908.js"><link rel="modulepreload" href="/assets/Authentication.html.07c5ec36.js"><link rel="modulepreload" href="/assets/Authentication.html.873d3cb1.js"><link rel="prefetch" href="/assets/index.html.5860b4a2.js" as="script" /><link rel="prefetch" href="/assets/Adding a New Field to Pacman.html.18cf48d0.js" as="script" /><link rel="prefetch" href="/assets/BulkUpload.html.319d08e4.js" as="script" /><link rel="prefetch" href="/assets/DomainEvents.html.d636f19d.js" as="script" /><link rel="prefetch" href="/assets/Tutorials.html.e3d2e5df.js" as="script" /><link rel="prefetch" href="/assets/New Organisations.html.c92b134b.js" as="script" /><link rel="prefetch" href="/assets/AzureEnvironment.html.5f16cc83.js" as="script" /><link rel="prefetch" href="/assets/BuildsAndDeployments.html.28a4adb9.js" as="script" /><link rel="prefetch" href="/assets/DatabaseScripts.html.e2142c72.js" as="script" /><link rel="prefetch" href="/assets/DataMigration.html.1e366e4a.js" as="script" /><link rel="prefetch" href="/assets/Merlin.html.7f8e27b5.js" as="script" /><link rel="prefetch" href="/assets/Monitoring.html.ee69b44d.js" as="script" /><link rel="prefetch" href="/assets/PMS.html.3ffa1e19.js" as="script" /><link rel="prefetch" href="/assets/Rider.html.45f99f4d.js" as="script" /><link rel="prefetch" href="/assets/Suppliers.html.3f17fe78.js" as="script" /><link rel="prefetch" href="/assets/404.html.d2dc3323.js" as="script" /><link rel="prefetch" href="/assets/index.html.ab4e5934.js" as="script" /><link rel="prefetch" href="/assets/Adding a New Field to Pacman.html.13a28cb1.js" as="script" /><link rel="prefetch" href="/assets/BulkUpload.html.38b05b5a.js" as="script" /><link rel="prefetch" href="/assets/DomainEvents.html.12d8673d.js" as="script" /><link rel="prefetch" href="/assets/Tutorials.html.7590eda2.js" as="script" /><link rel="prefetch" href="/assets/New Organisations.html.d5c6a793.js" as="script" /><link rel="prefetch" href="/assets/AzureEnvironment.html.fb2a8726.js" as="script" /><link rel="prefetch" href="/assets/BuildsAndDeployments.html.90bd2310.js" as="script" /><link rel="prefetch" href="/assets/DatabaseScripts.html.156e498f.js" as="script" /><link rel="prefetch" href="/assets/DataMigration.html.9cecf286.js" as="script" /><link rel="prefetch" href="/assets/Merlin.html.afd04fe7.js" as="script" /><link rel="prefetch" href="/assets/Monitoring.html.3fd29932.js" as="script" /><link rel="prefetch" href="/assets/PMS.html.7176dbfe.js" as="script" /><link rel="prefetch" href="/assets/Rider.html.afd1c89a.js" as="script" /><link rel="prefetch" href="/assets/Suppliers.html.ee62df65.js" as="script" /><link rel="prefetch" href="/assets/404.html.66012d09.js" as="script" />
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">PACDoc</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Overview <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/Overview/Authentication.md/" class="sidebar-item" aria-label="Authentication"><!--[--><!--]--> Authentication <!--[--><!--]--></a><!----></li><li><a href="/Overview/AzureEnvironment.md/" class="sidebar-item" aria-label="Azure Environment"><!--[--><!--]--> Azure Environment <!--[--><!--]--></a><!----></li><li><a href="/Overview/BuildsAndDeployments.md/" class="sidebar-item" aria-label="Builds And Deployments"><!--[--><!--]--> Builds And Deployments <!--[--><!--]--></a><!----></li><li><a href="/Overview/DatabaseScripts.md/" class="sidebar-item" aria-label="Database Scripts"><!--[--><!--]--> Database Scripts <!--[--><!--]--></a><!----></li><li><a href="/Overview/DataMigration.md/" class="sidebar-item" aria-label="Data Migration"><!--[--><!--]--> Data Migration <!--[--><!--]--></a><!----></li><li><a href="/Overview/Merlin.md/" class="sidebar-item" aria-label="Merlin"><!--[--><!--]--> Merlin <!--[--><!--]--></a><!----></li><li><a href="/Overview/Monitoring.md/" class="sidebar-item" aria-label="Monitoring"><!--[--><!--]--> Monitoring <!--[--><!--]--></a><!----></li><li><a href="/Overview/Rider.md/" class="sidebar-item" aria-label="Rider"><!--[--><!--]--> Rider <!--[--><!--]--></a><!----></li><li><a href="/Overview/PMS.md/" class="sidebar-item" aria-label="PMS"><!--[--><!--]--> PMS <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Pacman Items <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/Items/BulkUpload.md/" class="sidebar-item" aria-label="Bulk Upload"><!--[--><!--]--> Bulk Upload <!--[--><!--]--></a><!----></li><li><a href="/Items/Adding a New Field to Pacman.md/" class="sidebar-item" aria-label="Adding a New Field to Pacman"><!--[--><!--]--> Adding a New Field to Pacman <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Pacman Suppliers <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/Suppliers/Suppliers.md/" class="sidebar-item" aria-label="Suppliers"><!--[--><!--]--> Suppliers <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Organisations <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/Organisations/New Organisations.md/" class="sidebar-item" aria-label="Organisations"><!--[--><!--]--> Organisations <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Miscellaneous <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/Miscellaneous/DomainEvents.md/" class="sidebar-item" aria-label="DomainEvents"><!--[--><!--]--> DomainEvents <!--[--><!--]--></a><!----></li><li><a href="/Miscellaneous/Tutorials.md/" class="sidebar-item" aria-label="Tutorials"><!--[--><!--]--> Tutorials <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="authentication" tabindex="-1"><a class="header-anchor" href="#authentication" aria-hidden="true">#</a> Authentication</h1><h2 id="overview" tabindex="-1"><a class="header-anchor" href="#overview" aria-hidden="true">#</a> Overview</h2><p>Pacman uses Azure Active Directory for authentication.</p><p>IVC have a different Azure AD tenant for each country IVC operate in. IVC have only recently adopted AAD - the move to setup AAD is ongoing at the same time as the initial development of Pacman. Due to this, the authentication is setup in a way that can provide flexibility around what the chosen identity management is, whether that is IVC&#39;s Azure AD, a third-party tool like Azure B2C or different auth providers per country.</p><p>To do this Pacman uses <a href="https://identityserver.io/" target="_blank" rel="noopener noreferrer">IdentityServer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> as a <a href="http://docs.identityserver.io/en/latest/topics/federation_gateway.html" target="_blank" rel="noopener noreferrer">Federation Gateway<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, where the Pacman frontend client and api authenticate against IdentityServer (which is running as part of Pacman&#39;s API), which can then delegate user authentication to another provider. The auth provider can be changed without affecting how the API and frontend client behave (just changes to IdentityServer are needed), which should mean changing auth providers (or having different providers per country) is simpler.</p><h2 id="azure-active-directory" tabindex="-1"><a class="header-anchor" href="#azure-active-directory" aria-hidden="true">#</a> Azure Active Directory</h2><p>Pacman authenticates using IVC&#39;s Azure AD. User details are stored in AAD - Pacman has no visibility of passwords, etc. Authorisation and role assignment is managed through Pacman - users can be assigned Pacman roles through the Pacman UI.</p><h3 id="aad-setup" tabindex="-1"><a class="header-anchor" href="#aad-setup" aria-hidden="true">#</a> AAD setup</h3><p>Pacman needs to be registered as an application in each Azure AD tenant. This was done originally by Andrew Eliott at IVC, following these instructions:</p><p>Register an application in AAD. See https://docs.microsoft.com/en-gb/azure/active-directory/develop/quickstart-register-app</p><ul><li>Open the directory in the Azure Portal</li><li>Open App Registrations</li><li>Click New Registration</li><li>Enter app details: <ul><li>Enter an app name</li><li>For account types, choose &#39;Accounts in this organisation directory only&#39;</li><li>Leave the redirect URI blank</li><li>Click save</li></ul></li></ul><p>Configure the new registration to support authentication through Pacman - see the Azure docs for up to date information:</p><ul><li>From the app&#39;s overview page, open the Authentication section.</li><li>For each URL where the website will be accessed (IE for each different environment), add a redirect URI, with type Web, and URI https://<strong>domain</strong>/authentication/aad-<strong>countryName</strong>-signin, e.g. https://int-pricing.ivcevidensia.com/aad-uk-signin.</li><li>We’ll need these redirect URIs for each environment – i.e. Int / Test / UAT / QA / Production</li><li>Click save</li></ul><p>Create a client secret:</p><ul><li>Open the &#39;Certificates and secrets&#39; section.</li><li>Click &#39;New client secret&#39;.</li><li>Create a secret called Pacman API&#39;, which never expires.</li><li>Copy the secret value - we&#39;ll need it for the app config.</li></ul><p>In the &#39;Manifest&#39; section, update the &quot;accessTokenAcceptedVersion&quot; value to 2, and click Save.</p><p>The <code>appsettings.json</code> file should then be updated with the following values:</p><ul><li>The Azure AD tenant name</li><li>The Directory (tenant) ID from the Overview page on the app registration</li><li>The app registration Application (client) ID, from the Overview page</li><li>The client secret value, created above</li></ul><h3 id="test-users" tabindex="-1"><a class="header-anchor" href="#test-users" aria-hidden="true">#</a> Test users</h3><p>IVC have set up the following test users in AAD. These all share the same password, which can be found in LastPass.</p><table><thead><tr><th>Name</th><th>Country</th><th>Username</th></tr></thead><tbody><tr><td>Super Admin</td><td>UK</td><td>pacman_super_admin@ivcevidensia.com</td></tr><tr><td>Central User Admin</td><td>UK</td><td>pacman_uk_central_user_admin@ivcevidensia.com</td></tr><tr><td>Central View</td><td>UK</td><td>pacman_uk_central_view@ivcevidensia.com</td></tr><tr><td>Central Admin</td><td>UK</td><td>pacman_uk_central_admin@ivcevidensia.com</td></tr><tr><td>Site User Admin</td><td>UK</td><td>pacman_uk_site_user_admin@ivcevidensia.com</td></tr><tr><td>Site Price Admin</td><td>UK</td><td>pacman_uk_site_price_admin@ivcevidensia.com</td></tr><tr><td>Site Visibility Admin</td><td>UK</td><td>pacman_uk_site_visibility_admin@ivcevidensia.com</td></tr><tr><td>Sweden Super Admin</td><td>Sweden</td><td>pacman_sweden_super_admin@evidensia.se</td></tr><tr><td>Sweden Central User Admin</td><td>Sweden</td><td>pacman_sweden_central_user_admin@evidensia.se</td></tr><tr><td>Sweden Central View</td><td>Sweden</td><td>pacman_sweden_central_view@evidensia.se</td></tr></tbody></table><h2 id="identityserver" tabindex="-1"><a class="header-anchor" href="#identityserver" aria-hidden="true">#</a> <a href="https://identityserver.io/" target="_blank" rel="noopener noreferrer">IdentityServer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h2><p>IdentityServer is a .NET implementation of an OAuth 2.0 and OpenID Connect Authorisation Server. This library allows our API to act as an authorisation server, responsible for authenticating the user through OAuth / OpenID flows and issuing OAauth access tokens to the frontend.</p><p>Internally, authentication requests are federated out to Azure AD. This federation is done via OpenID Connect, using the OAuth Code Flow with PKCE to authenticate the user and return user details to Identity Server (in the form of a JWT Identity Token). Identity Server then sets its own authentication session for the user, storing user details in a cookie.</p><h2 id="oidc-client-js" tabindex="-1"><a class="header-anchor" href="#oidc-client-js" aria-hidden="true">#</a> <a href="https://github.com/IdentityModel/oidc-client-js" target="_blank" rel="noopener noreferrer">oidc-client-js<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h2><p>This is a Javascript library which provides OpenID Connect / OAuth2 client side support. It is used by the frontend to authenticate with the API servers IdentityServer endpoints.</p><p>Specifically, the Authorisation Code with PKCE OAuth flow is used by the frontend to obtain a JWT access token from Identity Server, which is sent to the API server with all requests.</p><h2 id="signing-certificates" tabindex="-1"><a class="header-anchor" href="#signing-certificates" aria-hidden="true">#</a> Signing certificates</h2><p>IdentityServer needs certificates to sign access tokens. These certificates are stored in Azure Key Vault - see <code>Scripts/Azure/CreateKeyVaultCertificates.ps1</code> script for details of how the certificates are created (you will need to install the AZ Powershell module to run the script, see <a href="https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-2.6.0" target="_blank" rel="noopener noreferrer">here<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>.</p><p>Key Vault is set up to rotate these certificates automatically. Identity Server supports key rollover by allowing past / future certificates to be marked as validation certificates only, meaning tokens signed by these certificates will be marked as valid, but the certificates will not be used to sign new tokens. This is needed to ensure old access tokens are not invalidated when the certificates are rolled over, and to accomodate for timing differences between how long different servers take to pick up the latest certificates.</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.4217e908.js" defer></script>
  </body>
</html>
