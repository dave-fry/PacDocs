import{_ as a,r,o as s,c as o,b as e,d as t,e as n,a as d}from"./app.4217e908.js";const c={},h=e("h1",{id:"authentication",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#authentication","aria-hidden":"true"},"#"),t(" Authentication")],-1),l=e("h2",{id:"overview",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#overview","aria-hidden":"true"},"#"),t(" Overview")],-1),u=e("p",null,"Pacman uses Azure Active Directory for authentication.",-1),p=e("p",null,"IVC have a different Azure AD tenant for each country IVC operate in. IVC have only recently adopted AAD - the move to setup AAD is ongoing at the same time as the initial development of Pacman. Due to this, the authentication is setup in a way that can provide flexibility around what the chosen identity management is, whether that is IVC's Azure AD, a third-party tool like Azure B2C or different auth providers per country.",-1),v={href:"https://identityserver.io/",target:"_blank",rel:"noopener noreferrer"},f={href:"http://docs.identityserver.io/en/latest/topics/federation_gateway.html",target:"_blank",rel:"noopener noreferrer"},_=d('<h2 id="azure-active-directory" tabindex="-1"><a class="header-anchor" href="#azure-active-directory" aria-hidden="true">#</a> Azure Active Directory</h2><p>Pacman authenticates using IVC&#39;s Azure AD. User details are stored in AAD - Pacman has no visibility of passwords, etc. Authorisation and role assignment is managed through Pacman - users can be assigned Pacman roles through the Pacman UI.</p><h3 id="aad-setup" tabindex="-1"><a class="header-anchor" href="#aad-setup" aria-hidden="true">#</a> AAD setup</h3><p>Pacman needs to be registered as an application in each Azure AD tenant. This was done originally by Andrew Eliott at IVC, following these instructions:</p><p>Register an application in AAD. See https://docs.microsoft.com/en-gb/azure/active-directory/develop/quickstart-register-app</p><ul><li>Open the directory in the Azure Portal</li><li>Open App Registrations</li><li>Click New Registration</li><li>Enter app details: <ul><li>Enter an app name</li><li>For account types, choose &#39;Accounts in this organisation directory only&#39;</li><li>Leave the redirect URI blank</li><li>Click save</li></ul></li></ul><p>Configure the new registration to support authentication through Pacman - see the Azure docs for up to date information:</p><ul><li>From the app&#39;s overview page, open the Authentication section.</li><li>For each URL where the website will be accessed (IE for each different environment), add a redirect URI, with type Web, and URI https://<strong>domain</strong>/authentication/aad-<strong>countryName</strong>-signin, e.g. https://int-pricing.ivcevidensia.com/aad-uk-signin.</li><li>We’ll need these redirect URIs for each environment – i.e. Int / Test / UAT / QA / Production</li><li>Click save</li></ul><p>Create a client secret:</p><ul><li>Open the &#39;Certificates and secrets&#39; section.</li><li>Click &#39;New client secret&#39;.</li><li>Create a secret called Pacman API&#39;, which never expires.</li><li>Copy the secret value - we&#39;ll need it for the app config.</li></ul><p>In the &#39;Manifest&#39; section, update the &quot;accessTokenAcceptedVersion&quot; value to 2, and click Save.</p><p>The <code>appsettings.json</code> file should then be updated with the following values:</p><ul><li>The Azure AD tenant name</li><li>The Directory (tenant) ID from the Overview page on the app registration</li><li>The app registration Application (client) ID, from the Overview page</li><li>The client secret value, created above</li></ul><h3 id="test-users" tabindex="-1"><a class="header-anchor" href="#test-users" aria-hidden="true">#</a> Test users</h3><p>IVC have set up the following test users in AAD. These all share the same password, which can be found in LastPass.</p><table><thead><tr><th>Name</th><th>Country</th><th>Username</th></tr></thead><tbody><tr><td>Super Admin</td><td>UK</td><td>pacman_super_admin@ivcevidensia.com</td></tr><tr><td>Central User Admin</td><td>UK</td><td>pacman_uk_central_user_admin@ivcevidensia.com</td></tr><tr><td>Central View</td><td>UK</td><td>pacman_uk_central_view@ivcevidensia.com</td></tr><tr><td>Central Admin</td><td>UK</td><td>pacman_uk_central_admin@ivcevidensia.com</td></tr><tr><td>Site User Admin</td><td>UK</td><td>pacman_uk_site_user_admin@ivcevidensia.com</td></tr><tr><td>Site Price Admin</td><td>UK</td><td>pacman_uk_site_price_admin@ivcevidensia.com</td></tr><tr><td>Site Visibility Admin</td><td>UK</td><td>pacman_uk_site_visibility_admin@ivcevidensia.com</td></tr><tr><td>Sweden Super Admin</td><td>Sweden</td><td>pacman_sweden_super_admin@evidensia.se</td></tr><tr><td>Sweden Central User Admin</td><td>Sweden</td><td>pacman_sweden_central_user_admin@evidensia.se</td></tr><tr><td>Sweden Central View</td><td>Sweden</td><td>pacman_sweden_central_view@evidensia.se</td></tr></tbody></table>',16),m={id:"identityserver",tabindex:"-1"},g=e("a",{class:"header-anchor",href:"#identityserver","aria-hidden":"true"},"#",-1),w={href:"https://identityserver.io/",target:"_blank",rel:"noopener noreferrer"},A=e("p",null,"IdentityServer is a .NET implementation of an OAuth 2.0 and OpenID Connect Authorisation Server. This library allows our API to act as an authorisation server, responsible for authenticating the user through OAuth / OpenID flows and issuing OAauth access tokens to the frontend.",-1),y=e("p",null,"Internally, authentication requests are federated out to Azure AD. This federation is done via OpenID Connect, using the OAuth Code Flow with PKCE to authenticate the user and return user details to Identity Server (in the form of a JWT Identity Token). Identity Server then sets its own authentication session for the user, storing user details in a cookie.",-1),b={id:"oidc-client-js",tabindex:"-1"},I=e("a",{class:"header-anchor",href:"#oidc-client-js","aria-hidden":"true"},"#",-1),k={href:"https://github.com/IdentityModel/oidc-client-js",target:"_blank",rel:"noopener noreferrer"},C=e("p",null,"This is a Javascript library which provides OpenID Connect / OAuth2 client side support. It is used by the frontend to authenticate with the API servers IdentityServer endpoints.",-1),S=e("p",null,"Specifically, the Authorisation Code with PKCE OAuth flow is used by the frontend to obtain a JWT access token from Identity Server, which is sent to the API server with all requests.",-1),P=e("h2",{id:"signing-certificates",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#signing-certificates","aria-hidden":"true"},"#"),t(" Signing certificates")],-1),T=e("code",null,"Scripts/Azure/CreateKeyVaultCertificates.ps1",-1),D={href:"https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-2.6.0",target:"_blank",rel:"noopener noreferrer"},z=e("p",null,"Key Vault is set up to rotate these certificates automatically. Identity Server supports key rollover by allowing past / future certificates to be marked as validation certificates only, meaning tokens signed by these certificates will be marked as valid, but the certificates will not be used to sign new tokens. This is needed to ensure old access tokens are not invalidated when the certificates are rolled over, and to accomodate for timing differences between how long different servers take to pick up the latest certificates.",-1);function U(V,x){const i=r("ExternalLinkIcon");return s(),o("div",null,[h,l,u,p,e("p",null,[t("To do this Pacman uses "),e("a",v,[t("IdentityServer"),n(i)]),t(" as a "),e("a",f,[t("Federation Gateway"),n(i)]),t(", where the Pacman frontend client and api authenticate against IdentityServer (which is running as part of Pacman's API), which can then delegate user authentication to another provider. The auth provider can be changed without affecting how the API and frontend client behave (just changes to IdentityServer are needed), which should mean changing auth providers (or having different providers per country) is simpler.")]),_,e("h2",m,[g,t(),e("a",w,[t("IdentityServer"),n(i)])]),A,y,e("h2",b,[I,t(),e("a",k,[t("oidc-client-js"),n(i)])]),C,S,P,e("p",null,[t("IdentityServer needs certificates to sign access tokens. These certificates are stored in Azure Key Vault - see "),T,t(" script for details of how the certificates are created (you will need to install the AZ Powershell module to run the script, see "),e("a",D,[t("here"),n(i)]),t(".")]),z])}const K=a(c,[["render",U],["__file","Authentication.html.vue"]]);export{K as default};
